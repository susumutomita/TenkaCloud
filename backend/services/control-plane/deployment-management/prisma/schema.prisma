generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["deployment"]
}

enum DeploymentStatus {
  PENDING
  IN_PROGRESS
  SUCCEEDED
  FAILED
  ROLLED_BACK

  @@schema("deployment")
}

enum DeploymentType {
  CREATE
  UPDATE
  ROLLBACK

  @@schema("deployment")
}

model Deployment {
  id            String           @id @default(uuid())
  tenantId      String
  tenantSlug    String
  namespace     String
  serviceName   String
  image         String
  version       String
  replicas      Int              @default(1)
  status        DeploymentStatus @default(PENDING)
  type          DeploymentType   @default(CREATE)
  previousImage String?
  errorMessage  String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  startedAt     DateTime?
  completedAt   DateTime?

  @@index([tenantId])
  @@index([tenantSlug])
  @@index([status])
  @@index([createdAt])
  @@map("deployments")
  @@schema("deployment")
}

model DeploymentHistory {
  id           String           @id @default(uuid())
  deploymentId String
  status       DeploymentStatus
  message      String?
  createdAt    DateTime         @default(now())

  @@index([deploymentId])
  @@index([createdAt])
  @@map("deployment_history")
  @@schema("deployment")
}
